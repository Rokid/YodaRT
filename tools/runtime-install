#!/usr/bin/env bash
set -e

help="
Usage:
  -t Only includes tests.
  -a Include tests.

Runtime installation by default, includes all packages, runtime, **no tests**.

Example:
  $ ./tools/runtime-install
"

os="YES"
test="NO"
while [ $# -gt 0 ]; do
  case "$1" in
    -t)
      test="YES"
      os="NO"
      ;;
    -a)
      test="YES"
      ;;
    --help)
      printf "$help"
      exit
      ;;
    -h)
      printf "$help"
      exit
      ;;
    --*)
      echo "Illegal option $1"
      ;;
  esac
  shift $(( $# > 0 ? 1 : 0 ))
done

function install_os() {
  adb shell "mount -o remount,rw /"

  echo "installing runtime..."
  adb shell "rm -rf /usr/lib/yoda/runtime"
  adb push ./runtime /usr/lib/yoda/ >/dev/null

  echo "installing system apps..."
  adb shell "rm -rf /opt/apps/*"
  adb push ./apps/* /opt/apps/ >/dev/null

  echo "installing resource..."
  adb shell "rm -rf /opt/media"
  adb shell "rm -rf /opt/light"
  adb push ./res/light /opt/ >/dev/null
  adb push ./res/media /opt/ >/dev/null

  adb shell mkdir -p /usr/lib/node_modules/@yoda
  adb push packages/* /usr/lib/node_modules >/dev/null
}

function install_test() {
  echo "installing tests..."
  adb shell 'rm -rf /data/workspace/test'
  adb shell mkdir -p /data/workspace/test
  adb push test/* /data/workspace/test >/dev/null
}

if test "$os" = "YES"; then
  install_os
fi

if test "$test" = 'YES'; then
  install_test
fi
